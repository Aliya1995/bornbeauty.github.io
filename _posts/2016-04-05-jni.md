---
layout: post
title: jni使用详解
category: 技术
tags: android
description: 开发中难免要使用jni，现在系统的学一下
---

> 开发中难免要使用jni，现在系统的学习总结一下使用的方法

##### 1 jni概述

  jni是Java Native Interface的缩写，中文译为“java本地方法接口”。通俗的说，jni是一种技术，通过jni你可以：

- java程序中的函数可以调用Native语言写的函数，Native一般是指C/C++编写的代码。
- Native程序中的函数可以调用Java层的函数，也就是说在C/C++程序中可以调用java的函数。

##### 2 加载jni库以及注册jni函数

  加载jni库非常简单，只需要在调用Native函数之前使用`System.loadLibrary("your_libray_name")`即可。我们的通常做法是在class中的静态块中加载，比如：

```java
package com.jimbo.jni;

public class JNIInterface {

  static {
    System.loadLibrary("your_libray_name");
  }

  //这里可以定义你的Native函数
  public static native final void native_say_hello();

}
```

知道了`java`代码编写的方法，那么问题来了，Native代码怎么编写呢？java函数怎么找到对应的Native函数呢？all right,让我们来看一下注册jni的两种方法。

- 静态方法

借助java的工具程序`javah`来实现这一过程。答题流程是这样的：

1. 编写java代码，然后编译生成`.class`文件。
2. 使用javah，例如`javah -o output packname.classname`来生成一个叫做`output.h`的头文件。
3. 在jni层实现这些函数。

上面的`JNIInterface`类经过上述操作后会得到这样的头文件：

```c
#include <jni.h>
//...省略
//注：如果java的函数中已经有了“_”，则"_"将会被替换成"_l"
JNIEXPORT void JNICALL Java_com_jimbo_jni_JNIInterface_native_lsay_lhello(JNIEnv *, jclass);

//...省略
```

可以看出，这个Native函数的名字就是包名+函数名，只是因为“.”在c中有特殊的含义，所以被替换成了"_"。这个过程是这样的：

> 当java层调用native_say_hello()函数时，他会从对应的JNI库中寻找Java_com_jimbo_jni_JNIInterface_native_lsay_lhello()函数，如果没有就会报错。如果找的到，则会为这个native_say_hello()和Java_com_jimbo_jni_JNIInterface_native_lsay_lhello()建立一个关联关系，其实就是保存jni层函数的函数指针。以后再调用native_say_hello()函数时，直接使用这个函数指针就可以了。当然这个过程是虚拟机来完成的，不需要我们操作。





end
